<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Messenger Clone</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#121212; color:#fff; }
    #app { max-width: 600px; margin: auto; height:100vh; display:flex; flex-direction:column; }
    header { background:#1f1f1f; padding:10px; text-align:center; font-size:18px; font-weight:bold; }
    #onlineUsers { font-size:12px; color:#aaa; text-align:center; margin-bottom:5px; }
    #messages { flex:1; overflow-y:auto; padding:10px; }
    .message { padding:8px; margin:5px; border-radius:8px; max-width:70%; position:relative; }
    .me { background:#0d6efd; margin-left:auto; text-align:right; }
    .other { background:#333; margin-right:auto; }
    .username { font-size:12px; opacity:0.7; }
    .time { font-size:10px; opacity:0.6; display:block; }
    .deleteBtn { position:absolute; top:2px; right:5px; font-size:12px; cursor:pointer; color:#ff6961; }
    .seen { font-size:10px; opacity:0.6; }
    footer { display:flex; padding:10px; background:#1f1f1f; }
    footer input { flex:1; padding:8px; border:none; border-radius:6px; }
    footer button { margin-left:5px; padding:8px 12px; border:none; border-radius:6px; background:#0d6efd; color:#fff; }
    #statusArea { display:none; background:#1c1c1c; padding:10px; }
    .status { padding:5px; border-bottom:1px solid #333; }
    #typing { font-size:12px; color:#aaa; margin:3px; }
  </style>
</head>
<body>
<div id="app">
  <header>Messenger Clone</header>
  <div id="onlineUsers"></div>
  <div id="typing"></div>
  
  <div id="statusArea">
    <input type="text" id="statusInput" placeholder="Durum yaz...">
    <button id="addStatusBtn">Paylaş</button>
    <div id="statusList"></div>
  </div>
  
  <div id="messages"></div>
  
  <footer>
    <input type="text" id="messageInput" placeholder="Mesaj yaz...">
    <button id="sendBtn">Gönder</button>
    <button id="statusBtn">Durum</button>
  </footer>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, remove, onChildRemoved, set, onValue, update } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

  // Firebase config seninki
  const firebaseConfig = {
    apiKey: "AIzaSyCGtiscjlxNrjMy0JIWSmg1xJ5Beqpe_1o",
    authDomain: "messen-7526f.firebaseapp.com",
    projectId: "messen-7526f",
    storageBucket: "messen-7526f.firebasestorage.app",
    messagingSenderId: "586198763347",
    appId: "1:586198763347:web:4fb30c0a8018f4228f03a6",
    databaseURL: "https://messen-7526f-default-rtdb.firebaseio.com/"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let username = prompt("Kullanıcı adını gir:");
  if(!username) username = "Anonim";

  const messagesRef = ref(db, "messages");
  const statusRef = ref(db, "status");
  const typingRef = ref(db, "typing/" + username);
  const usersRef = ref(db, "onlineUsers/" + username);

  // Çevrim içi kullanıcı kaydet
  set(usersRef, true);
  window.addEventListener("beforeunload", () => {
    set(usersRef, null);
  });

  // Çevrim içi kullanıcıları göster
  onValue(ref(db,"onlineUsers"), snap=>{
    const users = snap.val();
    if(users){
      document.getElementById("onlineUsers").innerText = "Çevrim içi: " + Object.keys(users).join(", ");
    } else {
      document.getElementById("onlineUsers").innerText = "Kimse yok";
    }
  });

  // Mesaj gönder
  document.getElementById("sendBtn").onclick = () => {
    const text = document.getElementById("messageInput").value.trim();
    if(text){
      push(messagesRef, { user: username, text: text, time: Date.now(), seen: false });
      document.getElementById("messageInput").value = "";
      set(typingRef,false);
    }
  };

  // Mesaj yazıyor...
  const input = document.getElementById("messageInput");
  input.addEventListener("input",()=>{
    set(typingRef,true);
    setTimeout(()=>set(typingRef,false),2000);
  });

  onValue(ref(db,"typing"), snap=>{
    let typingUsers = [];
    snap.forEach(child=>{
      if(child.key !== username && child.val()===true){
        typingUsers.push(child.key);
      }
    });
    document.getElementById("typing").innerText = typingUsers.length ? typingUsers.join(", ")+" yazıyor..." : "";
  });

  // Mesajları getir
  onChildAdded(messagesRef, (data) => {
    const msg = data.val();
    const div = document.createElement("div");
    div.classList.add("message");
    div.classList.add(msg.user === username ? "me" : "other");
    const date = new Date(msg.time);
    let saat = date.getHours().toString().padStart(2,"0")+":"+date.getMinutes().toString().padStart(2,"0");
    div.innerHTML = `<div class="username">${msg.user}</div>${msg.text}<span class="time">${saat}</span>`;
    
    // Görüldü (✓✓)
    if(msg.user !== username){
      update(ref(db,"messages/"+data.key),{seen:true});
    } else {
      if(msg.seen){
        div.innerHTML += `<span class="seen"> ✓✓ </span>`;
      }
    }

    // Silme butonları
    const del = document.createElement("span");
    del.innerText = "✖";
    del.className = "deleteBtn";
    del.onclick = () => remove(ref(db, "messages/" + data.key));
    div.appendChild(del);

    div.id = data.key;
    document.getElementById("messages").appendChild(div);
    document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
  });

  // Mesaj silinirse ekrandan kaldır
  onChildRemoved(messagesRef, (data) => {
    const elem = document.getElementById(data.key);
    if(elem) elem.remove();
  });

  // Durum ekle
  document.getElementById("addStatusBtn").onclick = () => {
    const text = document.getElementById("statusInput").value.trim();
    if(text){
      push(statusRef, { user: username, text: text, time: Date.now() });
      document.getElementById("statusInput").value = "";
    }
  };

  // Durumları getir
  onChildAdded(statusRef, (data) => {
    const s = data.val();
    const div = document.createElement("div");
    div.classList.add("status");
    const date = new Date(s.time);
    div.innerHTML = `${s.user}: ${s.text} <span class="time">${date.toLocaleString()}</span>`;
    document.getElementById("statusList").appendChild(div);
  });

  // Durum alanı aç/kapat
  document.getElementById("statusBtn").onclick = () => {
    const area = document.getElementById("statusArea");
    area.style.display = area.style.display === "none" ? "block" : "none";
  };
</script>
</body>
</html>
